<modification>
	<id>Simple SEO URL Generator</id>
	<version>1.0.3</version>
	<vqmver>2.4.0</vqmver>
	<author>edirpedro.com.br</author>
	
	<file name="system/library/url.php">
		<operation error="log">
			<search position="after">
				<![CDATA[
					class Url {
				]]>
			</search>
			<add>
				<![CDATA[
					// Set this TRUE if you want to force keyword updates on every change
					// When TRUE, you won't be able to customize keywords
					public $force_keyword = false;
					
					public function seoURL($args) {
						// Setting url string
						$str = $args['string'];
						// $str = preg_replace('/[`^~\'"]/', null, iconv('UTF-8', 'ASCII//TRANSLIT', $str)); // Better but don't work in some servers
						$str = html_entity_decode($str, ENT_QUOTES, 'UTF-8');
						$str = preg_replace('~&([a-z]{1,2})(amp|acute|cedil|circ|grave|lig|orn|ring|slash|th|tilde|uml);~i', '$1', htmlentities($str, ENT_QUOTES, 'UTF-8'));
						$str = preg_replace('/[^a-zA-Z0-9]+/', '-', html_entity_decode($str, ENT_QUOTES, 'UTF-8'));
						$str = trim($str, '-');
						$str = strtolower($str);
						
						// Avoid duplication
						$db = $args['db'];
						if ($db) {
							$okay = false;
							$counter = 1;
							$modifier = '';
							do {
								if($counter > 1)
									$modifier = '-' . $counter;
								$result = $db->query("SELECT COUNT(*) as `total` FROM " . DB_PREFIX . "url_alias WHERE keyword = '" . $db->escape($str . $modifier) . "' AND query != '" . $args['query'] . "'");
								if($result->row['total'] == 0) {
									$str .= $modifier;
									$okay = true;
								} else
									$counter++;
							} while($okay == false);
						}
						
					 	return $str;
					}
				]]>
			</add>
		</operation>		
	</file>

	<file name="admin/model/catalog/category.php">
		<operation error="log">
			<search position="before">
				<![CDATA[
					if ($data['keyword']) {
				]]>
			</search>
			<add>
				<![CDATA[
					if ($this->url->force_keyword || empty($data['keyword']))
						$data['keyword'] = $data['category_description'][$language_id]['name'];
					
					$data['keyword'] = $this->url->seoURL(array(
						'string' => $data['keyword'],
						'query' => 'category_id=' . (int) $category_id,
						'db' => $this->db
						));
			 	]]>
			</add>
		</operation>
	</file>
	
	<file name="admin/model/catalog/information.php">
		<operation error="log">
			<search position="before">
				<![CDATA[
					if ($data['keyword']) {
				]]>
			</search>
			<add>
				<![CDATA[
					if ($this->url->force_keyword || empty($data['keyword']))
						$data['keyword'] = $data['information_description'][$language_id]['title'];
					
					$data['keyword'] = $this->url->seoURL(array(
						'string' => $data['keyword'],
						'query' => 'information_id=' . (int) $information_id,
						'db' => $this->db
						));
			 	]]>
			</add>
		</operation>
	</file>
	
	<file name="admin/model/catalog/manufacturer.php">
		<operation error="log">
			<search position="before">
				<![CDATA[
					if ($data['keyword']) {
				]]>
			</search>
			<add>
				<![CDATA[
					if ($this->url->force_keyword || empty($data['keyword']))
						$data['keyword'] = $data['name'];
					
					$data['keyword'] = $this->url->seoURL(array(
						'string' => $data['keyword'],
						'query' => 'manufacturer_id=' . (int) $manufacturer_id,
						'db' => $this->db
						));
			 	]]>
			</add>
		</operation>
	</file>
	
	<file name="admin/model/catalog/product.php">
		<operation error="log">
 			<search position="before">
				<![CDATA[
					if ($data['keyword']) {
				]]>
			</search>
			<add>
				<![CDATA[
					if ($this->url->force_keyword || empty($data['keyword']))
						$data['keyword'] = $data['product_description'][$language_id]['name'];
					
					$data['keyword'] = $this->url->seoURL(array(
						'string' => $data['keyword'],
						'query' => 'product_id=' . (int) $product_id,
						'db' => $this->db
						));
			 	]]>
			</add>
		</operation>	
	</file>

</modification>